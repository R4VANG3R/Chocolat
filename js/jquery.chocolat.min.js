/*
 **      @author : Nicolas Turlais : nicolas-at-insipi.de
 **      @version : V0.4.4 - 16 April 2014
 **      @license : Licensed under CCAttribution-ShareAlike
 **      @website : http://chocolat.insipi.de
 **/
(function(e,t,n,r){function o(t,n){var r=this;this.settings=n;this._defaults=s;this.elems={};t.find(this.settings.imageSelector).each(function(){r.settings.images.push({title:e(this).attr("title"),src:e(this).attr("href"),height:false,width:false})});if(n.displayAsALink){this.createLink().off("click").on("click",function(e){r.init(r.settings.firstImage);e.preventDefault()});t.hide()}else{t.find(this.settings.imageSelector).each(function(t){e(this).off("click").on("click",function(e){r.init(t);e.preventDefault()})})}return{open:function(e){e=e||0;r.init(e)},close:function(){r.close()},next:function(){r.change(1)},prev:function(){r.change(-1)},"goto":function(e){r.init(e)},current:function(){return r.currentImage}}}var i=0;var s={container:t,linksContainer:".chocolat-links",imageSelector:".chocolat-image",fullWindow:false,fullScreen:false,displayAsALink:false,loop:false,linkImages:true,setTitle:"",separator1:"|",separator2:"/",mobileBreakpoint:480,setIndex:0,firstImage:0,lastImage:false,currentImage:false,initialized:false,timer:false,timerDebounce:false,images:[],offsetTop:0,offsetBot:0};o.prototype={init:function(e){if(!this.settings.initialized){this.setDomContainer();this.markup();this.events();this.settings.lastImage=this.settings.images.length-1;this.settings.initialized=true}this.load(e)},preload:function(t,n){n=this.optFuncParam(n);imgLoader=new Image;imgLoader.onload=e.proxy(n,this,t,imgLoader);imgLoader.src=this.settings.images[t].src},load:function(t){if(this.settings.fullScreen){this.openFullScreen()}if(this.settings.currentImage===t){return}this.elems.overlay.fadeIn(800);this.settings.timer=setTimeout(function(){e.proxy(this.elems.loader.fadeIn(),this)},400);this.preload(t,this.place)},place:function(t,n){var r=this;this.settings.currentImage=t;this.description();this.pagination();this.breakpoint();this.elems.img.fadeTo(200,0,function(){r.storeImgSize(n,t);fitting=r.fit(r.settings.images[t].height,r.settings.images[t].width,e(r.settings.container).height(),e(r.settings.container).width(),r.getOutMarginH(),r.getOutMarginW());r.center(fitting.width,fitting.height,fitting.left,fitting.top,150,r.appear(t));r.arrows()})},appear:function(e){var t=this;clearTimeout(this.settings.timer);this.elems.loader.stop().fadeOut(300,function(){t.elems.img.attr("src",t.settings.images[e].src).fadeTo(400,1)})},fit:function(e,t,n,r,i,s){var o=r-s;var u=n-i;var a=u/o;var f=n/r;var l=e/t;if(this.settings.fullWindow=="cover"){if(l<f){height=n;width=height/l}else{width=r;height=width*l}}else{if(l>a){height=u;width=height/l}else{width=o;height=width*l}if(!this.settings.fullWindow&&(width>=t||height>=e)){width=t;height=e}}return{height:height-this.settings.offsetTop-this.settings.offsetBot,width:width,top:(n-height)/2+this.settings.offsetTop,left:(r-width)/2}},center:function(t,n,r,i,s,o){o=this.optFuncParam(o);this.elems.content.animate({width:t,height:n,left:r,top:i},s,e.proxy(o(),this)).css("overflow","visible")},change:function(e){var t=this.settings.currentImage+parseInt(e);if(t>this.settings.lastImage){if(this.settings.loop){this.load(0)}}else if(t<0){if(this.settings.loop){this.load(this.settings.lastImage)}}else{this.load(t)}},arrows:function(){if(this.settings.loop){e([this.elems.left[0],this.elems.right[0]]).css("display","block")}else if(this.settings.linkImages){if(this.settings.currentImage==this.settings.lastImage){this.elems.right.fadeOut(300)}else{this.elems.right.fadeIn(300)}if(this.settings.currentImage==0){this.elems.left.fadeOut(300)}else{this.elems.left.fadeIn(300)}}else{e([this.elems.left[0],this.elems.right[0]]).css("display","none")}},description:function(){var t=this;this.elems.description.fadeTo(200,0,function(){e(this).html(t.settings.images[t.settings.currentImage].title).fadeTo(400,1)})},pagination:function(){var t=this;var n=this.settings.lastImage+1;var r=this.settings.currentImage+1;var i=this.settings.setTitle==""?"":this.settings.separator1;this.elems.pagination.fadeTo(200,0,function(){e(this).html(t.settings.setTitle+" "+i+" "+r+t.settings.separator2+n).fadeTo(400,1)})},breakpoint:function(){if(e(this.settings.container).width()<this.settings.mobileBreakpoint){this.elems.domContainer.addClass("chocolat-mobile")}else{this.elems.domContainer.removeClass("chocolat-mobile")}},storeImgSize:function(e,t){if(!this.settings.images[t].height||!this.settings.images[t].width){this.settings.images[t].height=e.height;this.settings.images[t].width=e.width}},close:function(){var t=[this.elems.overlay[0],this.elems.loader[0],this.elems.content[0]];var n=this;e.when(e(t).fadeOut(200)).then(function(){n.elems.domContainer.removeClass("chocolat-open chocolat-mobile chocolat-in-container chocolat-cover")});this.settings.currentImage=false;this.settings.initialized=false},getOutMarginW:function(){var e=this.elems.left.outerWidth()-this.elems.left.width();var t=this.elems.right.outerWidth()-this.elems.right.width();return e+t},getOutMarginH:function(){return this.elems.top.outerHeight()+this.elems.bottom.outerHeight()},markup:function(){this.elems.domContainer.addClass("chocolat-open");if(this.settings.fullWindow=="cover"){this.elems.domContainer.addClass("chocolat-cover")}if(this.settings.container!==t){this.elems.domContainer.addClass("chocolat-in-container")}var n=this;this.elems.overlay=e("<div/>",{"class":"chocolat-overlay"}).appendTo(this.elems.domContainer);this.elems.loader=e("<div/>",{"class":"chocolat-loader"}).appendTo(this.elems.domContainer);this.elems.content=e("<div/>",{"class":"chocolat-content",id:"chocolat-content-"+this.settings.setIndex}).appendTo(this.elems.domContainer);this.elems.img=e("<img/>",{"class":"chocolat-img",src:""}).appendTo(this.elems.content);this.elems.top=e("<div/>",{"class":"chocolat-top"}).appendTo(this.elems.content);this.elems.left=e("<div/>",{"class":"chocolat-left"}).appendTo(this.elems.content);this.elems.right=e("<div/>",{"class":"chocolat-right"}).appendTo(this.elems.content);this.elems.bottom=e("<div/>",{"class":"chocolat-bottom"}).appendTo(this.elems.content);this.elems.description=e("<span/>",{"class":"chocolat-description"}).appendTo(this.elems.bottom);this.elems.pagination=e("<span/>",{"class":"chocolat-pagination"}).appendTo(this.elems.bottom);this.elems.close=e("<span/>",{"class":"chocolat-close"}).appendTo(this.elems.top)},createLink:function(){var t=e("<li/>").appendTo(this.settings.linksContainer);return e("<a/>",{id:"chocolat-set-"+this.settings.setIndex,"class":"chocolat-link",href:"#"}).html(this.settings.setTitle).appendTo(t)},openFullScreen:function(){var e=n.documentElement;if(e.requestFullscreen){e.requestFullscreen()}else if(e.mozRequestFullScreen){e.mozRequestFullScreen()}else if(e.webkitRequestFullScreen){e.webkitRequestFullScreen()}},events:function(){var r=this;e(n).off("keydown").on("keydown",function(e){if(r.settings.initialized){if(e.keyCode==37){r.change(-1)}else if(e.keyCode==39){r.change(1)}else if(e.keyCode==27){r.close()}}});e(this.elems.content).find(".chocolat-right").off("click").on("click",function(){r.change(+1)});e(this.elems.content).find(".chocolat-left").off("click").on("click",function(){r.change(-1)});e([this.elems.overlay[0],this.elems.close[0]]).off("click").on("click",function(){r.close()});e(t).on("resize",function(){if(!r.settings.initialized){return}r.debounce(50,function(){r.breakpoint();fitting=r.fit(r.settings.images[r.settings.currentImage].height,r.settings.images[r.settings.currentImage].width,e(r.settings.container).height(),e(r.settings.container).width(),r.getOutMarginH(),r.getOutMarginW());r.center(fitting.width,fitting.height,fitting.left,fitting.top,150)})})},setDomContainer:function(){if(typeof this.settings.container==="object"){this.elems.domContainer=e("body")}else{this.elems.domContainer=e(this.settings.container)}},debounce:function(e,t){clearTimeout(this.settings.timerDebounce);this.settings.timerDebounce=setTimeout(function(){t()},e)},optFuncParam:function(t){if(!e.isFunction(t)){return function(){}}else{return t}}};e.fn["Chocolat"]=function(t){return this.each(function(){i++;var n=e.extend(true,{},s,t,{setIndex:i});if(!e.data(this,"api-chocolat")){e.data(this,"api-chocolat",new o(e(this),n))}})}})(jQuery,window,document)